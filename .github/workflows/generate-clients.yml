name: Generate Vet Plus Client

on:
   push:
   #    tags:
   #       - '*.*.*'
   # workflow_dispatch:

permissions:
   contents: write
   packages: write

jobs:
   generate-schema:
      runs-on: ubuntu-latest
      steps:
      -  name: Checkout Repository
         uses: actions/checkout@v4

      -  name: Set up Python
         uses: actions/setup-python@v5
         with:
            python-version: '3.12'
      -  name: Cache Python Dependencies
         uses: actions/cache@v4
         with:
            path: ~/.cache/pip
            key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
            restore-keys: |
               ${{ runner.os }}-pip-

      -  name: Install Backend Dependencies
         run: pip install -r requirements.txt

      -  name: Run FastAPI Server
         run: |
            nohup fastapi dev app/main.py &
            sleep 10
            curl --retry 5 --retry-delay 2 --retry-connrefused http://localhost:8000/docs

      -  name: Download OpenAPI Schema
         run: curl -o openapi.json http://localhost:8000/openapi.json

      -  name: Upload Schema Artifact
         uses: actions/upload-artifact@v4
         with:
            name: openapi-schema
            path: openapi.json

   generate-client:
      runs-on: ubuntu-latest
      needs: generate-schema
      steps:
      -  name: Checkout Repository
         uses: actions/checkout@v4

      -  name: Baixar Artefato Schema
         uses: actions/download-artifact@v4
         with:
            name: openapi-schema

      -  name: Set Package Version
         run: |
            REF="${GITHUB_REF}"
            echo "Detected ref: $REF"
            if [[ "$REF" == refs/tags/* ]]; then
               VERSION="${REF#refs/tags/}"
               VERSION="${VERSION#v}"
               echo "Detected tag -> VERSION=$VERSION"
            elif [[ "$REF" == refs/heads/* ]]; then
               BRANCH="${REF#refs/heads/}"
               # Substitui / por - pra nÃ£o quebrar o nome
               SAFE_BRANCH="${BRANCH//\//-}"
               VERSION="0.0.0-${SAFE_BRANCH}-build-${GITHUB_RUN_NUMBER}"
               echo "Detected branch -> VERSION=$VERSION"
            else
               VERSION="0.0.0-unknown-${GITHUB_RUN_ID}"
               echo "Fallback -> VERSION=$VERSION"
            fi
            echo "VERSION=$VERSION" >> $GITHUB_ENV

      -  name: Generate TypeScript client
         uses: openapi-generators/openapitools-generator-action@v1
         with:
            generator: typescript-axios
            openapi-file: openapi.json
            command-args: --additional-properties=npmName="@noobs-corp-labs/vet-plus-backend",npmVersion="${{ env.VERSION }}",supportsES6=true

      -  name: Set Up NPM Environment
         uses: actions/setup-node@v4
         with:
            node-version: '20'
            registry-url: 'https://npm.pkg.github.com'
      
      -  name: Cache Node Dependencies
         uses: actions/cache@v4
         with:
            path: ~/.npm
            key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
            restore-keys: |
               ${{ runner.os }}-npm-

      -  name: Install, Pack, and Publish to GitHub Packages
         working-directory: typescript-axios-client
         run: |
            npm install
            npm pack
            npm publish --access public
         env:
            NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      -  name: Upload Package Artifact
         uses: actions/upload-artifact@v4
         with:
            name: typescript-axios-package
            path: typescript-axios-client/*.tgz
      
   upload-release:
      runs-on: ubuntu-latest
      needs: generate-client
      if: github.event_name == 'release'
      steps:

      -  name: Download Package Artifact
         uses: actions/download-artifact@v4
         with:
            name: typescript-axios-package

      -  name: Upload Release Asset
         uses: actions/upload-release-asset@v1
         env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
         with:
            upload_url: ${{ github.event.release.upload_url }}
            asset_path: ./*.tgz
            asset_name: ${{ github.event.repository.name }}-ts-axios-client-${{ github.ref_name }}.tgz
            asset_content_type: application/gzip